import { useState } from "react";
import { Button } from "@/components/ui/button";
import { motion } from "framer-motion";
import { PieChart, Pie, Cell } from "recharts";

const defaultStudents = [
  "Alice", "Ben", "Chloe", "David", "Emma", "Frank", "Grace", "Hannah",
  "Ian", "Jane", "Kyle", "Lily", "Mike", "Nora", "Owen", "Paula",
  "Quinn", "Riley", "Sam", "Tina", "Umar", "Violet", "Wes", "Xander",
  "Yara", "Zane", "Aiden", "Bella", "Caleb", "Diana"
];

const COLORS = [
  "#8884d8", "#8dd1e1", "#82ca9d", "#ffc658", "#d0ed57",
  "#a4de6c", "#d88884", "#d4a4ff", "#ffd6a5", "#b5ead7",
  "#ff9aa2", "#cbaacb", "#ffdac1", "#e2f0cb", "#b5ead7",
  "#ffb7b2", "#f3ffe3", "#f9f9f9", "#e4f0f5", "#dbe9f4",
  "#a1c6ea", "#c1e1c1", "#f7cac9", "#92a8d1", "#f7786b",
  "#deeaee", "#b7d7e8", "#f0efeb", "#decba4", "#d5f4e6"
];

export default function InteractiveStudentSpinner() {
  const [students, setStudents] = useState(defaultStudents);
  const [inputText, setInputText] = useState(defaultStudents.join(", "));
  const [selected, setSelected] = useState(null);
  const [spinning, setSpinning] = useState(false);
  const [history, setHistory] = useState([]);
  const [rotation, setRotation] = useState(0);

  const updateNames = () => {
    const names = inputText
      .split(",")
      .map(n => n.trim())
      .filter(n => n)
      .slice(0, 30);
    setStudents(names);
    setHistory([]);
    setSelected(null);
  };

  const spin = () => {
    if (students.length === 0) return;
    setSpinning(true);
    const duration = 3000;
    const spins = 5;
    const anglePerStudent = 360 / students.length;
    const selectedIndex = Math.floor(Math.random() * students.length);
    const finalRotation = spins * 360 + anglePerStudent * selectedIndex + Math.random() * anglePerStudent;

    setRotation(prev => prev + finalRotation);

    setTimeout(() => {
      const winner = students[selectedIndex];
      setSelected(winner);
      setHistory(prev => [winner, ...prev]);
      setStudents(prev => prev.filter(s => s !== winner));
      setSpinning(false);
    }, duration);
  };

  const pieData = students.map(name => ({ name, value: 1 }));

  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200 p-6 space-y-4">
      <h1 className="text-4xl font-bold">ðŸŽ¯ Student Spinner</h1>

      <textarea
        value={inputText}
        onChange={e => setInputText(e.target.value)}
        rows={3}
        className="w-full max-w-xl p-3 border rounded shadow"
        placeholder="Enter up to 30 names separated by commas"
      />
      <Button onClick={updateNames}>Update Student List</Button>

      <motion.div
        animate={{ rotate: spinning ? rotation : rotation }}
        transition={{ duration: spinning ? 3 : 0 }}
        className="w-[300px] h-[300px] flex items-center justify-center"
      >
        <PieChart width={300} height={300}>
          <Pie
            data={pieData}
            dataKey="value"
            nameKey="name"
            cx="50%"
            cy="50%"
            outerRadius={120}
            innerRadius={60}
            fill="#8884d8"
            label={({ name }) => name.length > 8 ? name.slice(0, 8) + 'â€¦' : name}
          >
            {pieData.map((_, index) => (
              <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
            ))}
          </Pie>
        </PieChart>
      </motion.div>

      <Button onClick={spin} className="px-6 py-3 text-lg rounded-xl">
        {spinning ? "Spinning..." : "Spin"}
      </Button>

      {selected && !spinning && (
        <motion.p
          initial={{ scale: 0 }}
          animate={{ scale: 1 }}
          transition={{ type: "spring", stiffness: 200 }}
          className="text-2xl text-indigo-800 font-semibold"
        >
          ðŸŽ‰ Selected: {selected}!
        </motion.p>
      )}

      {history.length > 0 && (
        <div className="mt-4 text-center">
          <h2 className="text-lg font-bold">History</h2>
          <ul className="mt-2 space-y-1">
            {history.map((name, idx) => (
              <li key={idx}>âœ… {name}</li>
            ))}
          </ul>
        </div>
      )}
    </div>
  );
}
